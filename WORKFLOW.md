# Echo 工作流程说明

## 🎯 当前实现的流程

### 阶段 1：灵魂访谈（Interview）
**位置：** `/interview`

1. 用户回答 12 个深度心理问题
2. 问题涵盖 4 个维度：
   - 情感维度（Emotion）
   - 沟通维度（Communication）
   - 价值观维度（Values）
   - 审美维度（Aesthetic）
3. 答案自动保存到 localStorage
4. 完成后自动跳转到生成页面

---

### 阶段 2：人格生成（Personality Generation）
**位置：** `/generate`  
**AI 服务：** DeepSeek API

#### 流程：
1. ✅ **自动触发**：访谈完成后自动开始
2. ✅ **调用 DeepSeek**：生成人格描述（3-8 秒）
3. ✅ **显示人格档案**：
   - 名字（如：星河）
   - 标语（如：在沉默中读懂你的声音）
   - 关键词（3-5 个性格特质）
   - 沟通风格
   - 价值观
   - 为什么匹配
   - 独特特质

#### 用户选择：
- **选项 A：生成 TA 的形象** → 进入阶段 3
- **选项 B：暂不生成，查看档案** → 直接到档案页（无图片）

---

### 阶段 3：图像生成（Image Generation）⭐ 手动触发
**位置：** `/generate`（点击按钮后）  
**AI 服务：** Google Gemini Imagen 4

#### 流程：
1. ✅ **用户点击**："生成 TA 的形象"按钮
2. ✅ **调用 Gemini Imagen 4**：生成 3 张高质量图像（2-5 秒/张）
3. ✅ **回退机制**：
   - 主力：Imagen 4 Standard
   - 备用1：Replicate Flux Pro
   - 备用2：Replicate SDXL
4. ✅ **完成提示**：自动跳转到档案页

---

### 阶段 4：档案展示（Profile）
**位置：** `/profile`

显示内容：
- ✅ Echo 名字和标语
- ✅ 关键词标签
- ✅ 图像画廊（如果已生成）
- ✅ 完整人格描述
- ✅ 独特特质

功能按钮：
- 📤 **分享我的 Echo**（生成分享卡片）
- 🔄 **重新生成**（微调人格或图像）
- 💾 **下载形象**

---

## 💡 关键设计决策

### 1. 为什么分两步生成？

**原因：**
- ✅ **成本控制**：让用户先看到人格，决定是否继续
- ✅ **速度优化**：人格生成快（3-8秒），图像慢（10-15秒）
- ✅ **用户体验**：避免长时间等待，给用户控制感
- ✅ **灵活性**：用户可能只想要文字描述

### 2. 图像生成方案

**使用 Google Gemini Imagen 4：**
- ✅ 速度快（2-5 秒/张）
- ✅ 质量高（Standard 模式）
- ✅ 价格合理（$0.03/张 ≈ ¥0.21/张）
- ✅ 支持中文 prompt
- ✅ 有多重回退保证成功率

---

## 🔄 完整流程示意图

```
用户进入 Echo
    ↓
📝 灵魂访谈（12 个问题）
    ↓
⏱️ 自动触发：DeepSeek 生成人格（3-8s）
    ↓
📊 显示完整人格描述
    ↓
┌───────────────────────────────┐
│  用户选择：                    │
│  A. 生成形象 → Imagen 4 (5-15s)│
│  B. 暂不生成 → 直接查看档案     │
└───────────────────────────────┘
    ↓
🎨 档案页面（可选择性显示图片）
    ↓
📤 分享 / 🔄 重新生成
```

---

## 🎨 UI/UX 特点

### 生成页面特色：
1. **进度指示**
   - 加载动画（旋转的 Sparkles 图标）
   - 进度条（0% → 100%）
   - 阶段提示（"DeepSeek 正在理解你的灵魂"）

2. **人格展示**
   - 大标题显示名字（渐变色）
   - 关键词卡片
   - 详细档案卡片（glassmorphism 效果）
   - 清晰的行动按钮

3. **图像生成**
   - 按钮状态：正常 / 加载中
   - 加载时显示旋转图标
   - 进度实时更新

---

## 💰 成本分析

### 每个 Echo 生成成本：

**仅人格（选项 B）：**
- DeepSeek 人格生成：¥0.01
- **总计：¥0.01**

**人格 + 图像（选项 A）：**
- DeepSeek 人格生成：¥0.01
- Imagen 4 图像生成 × 3：¥0.21
- **总计：¥0.22**

### 用户价值：
- 100% 用户获得人格描述（¥0.01）
- 假设 80% 用户选择生成图像（¥0.22）
- **平均成本：¥0.18/用户**

---

## 🔧 技术实现

### API 调用顺序：

1. **POST `/api/generate-personality`**
   - 输入：访谈答案数组
   - 输出：PersonalityProfile 对象
   - 时长：3-8 秒

2. **POST `/api/generate-image`**（用户触发）
   - 输入：PersonalityProfile + count + aspectRatio
   - 输出：图像 URL 数组 + 使用的模型
   - 时长：5-15 秒

### 状态管理：

```typescript
// Interview Store
- currentQuestionIndex
- answers[]
- startTime
- completedAt

// Generation Store  
- personality: PersonalityProfile | null
- images: string[]
- selectedImageIndex
- status: "idle" | "generating-personality" | "completed" | "error"
```

---

## 🚀 开发进度

### ✅ 已完成
- [x] 12 个深度访谈问题
- [x] DeepSeek 人格生成
- [x] Gemini Imagen 4 图像生成
- [x] 多重回退机制（Imagen → Flux → SDXL）
- [x] 分步生成流程
- [x] 完整档案展示
- [x] 分享卡片功能
- [x] 重新生成功能
- [x] 响应式设计

### 🎯 未来优化
- [ ] 图像生成参数调整（style, mood）
- [ ] 视频生成（Veo 3）
- [ ] 用户认证
- [ ] Echo 历史记录
- [ ] 社区画廊

---

## 📝 用户测试检查清单

测试时请验证：

1. ✅ 访谈流程流畅，12 个问题都不同
2. ✅ 人格生成成功，内容详细且中文流畅
3. ✅ 显示人格后，有明确的"生成形象"按钮
4. ✅ 可以选择"暂不生成"直接查看档案
5. ✅ 点击生成形象后，图像在 15 秒内完成
6. ✅ 生成 3 张不同的图像
7. ✅ 档案页面完整显示所有信息
8. ✅ 可以下载和分享

---

**文档版本：** v2.0-split-generation  
**更新日期：** 2024-10-25  
**状态：** ✅ 已实施

